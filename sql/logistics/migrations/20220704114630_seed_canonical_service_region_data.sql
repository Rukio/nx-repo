-- +goose Up
-- +goose StatementBegin
INSERT INTO
    service_region_canonical_location_sets(service_region_id)
SELECT
    service_region_id
FROM
    markets;

CREATE TEMP TABLE market_locations AS (
    SELECT
        *
    FROM
        (
            VALUES
                (159, 39925342, -105084063),
                (159, 39665504, -104941790),
                (160, 38892838, -104752861),
                (161, 33568183, -112016599),
                (161, 33564412, -112286008),
                (161, 33350289, -111730975),
                (162, 36142389, -115173395),
                (164, 37503416, -77480200),
                (165, 29866547, -95330837),
                (165, 30166954, -95489938),
                (165, 29630247, -95182353),
                (165, 29703868, -95583129),
                (166, 35564883, -97441007),
                (166, 35405387, -97553575),
                (168, 42146390, -72549296),
                (168, 42448907, -72680869),
                (169, 32776954, -96787021),
                (169, 33025430, -96765036),
                (170, 47207709, -122363019),
                (171, 41078523, -74097252),
                (171, 40900074, -74068554),
                (172, 47032767, -122886892),
                (173, 47688511, -117388230),
                (174, 47863556, -122220327),
                (174, 47567303, -122269391),
                (175, 45475857, -122677005),
                (176, 43621782, -116363586),
                (177, 33495196, -84380721),
                (177, 33838882, -84441596),
                (177, 33950267, -84097518),
                (178, 33169299, -97135667),
                (178, 32756148, -97225945),
                (179, 39534689, -119796594),
                (179, 39169407, -119779587),
                (181, 27953711, -82434681),
                (181, 27911304, -82721226),
                (185, 40677234, -74300717),
                (185, 40917792, -74548593),
                (186, 41786410, -72733647),
                (186, 41578205, -73043015),
                (186, 41826815, -72405426),
                (188, 39720930, -86215758),
                (188, 40134891, -85575883),
                (188, 39992921, -86059363),
                (189, 35782124, -78660304),
                (189, 36043159, -78943759),
                (190, 41369201, -81838960),
                (190, 41026221, -81514016),
                (190, 41483886, -81517049),
                (191, 35933180, -86294203),
                (191, 36088064, -86771795),
                (191, 36415101, -86663962),
                (191, 36145335, -87170709),
                (192, 35709415, -84285623),
                (192, 35969575, -84008387),
                (192, 36073399, -83652003),
                (193, 25813143, -80229893),
                (193, 25575808, -80419606),
                (194, 29479474, -98504299),
                (195, 32220424, -110950997),
                (196, 28615374, -81419688),
                (196, 28305523, -81462873),
                (197, 29068312, -81121759),
                (197, 29428794, -81171427),
                (198, 39986633, -82626003),
                (198, 40006579, -83023272),
                (199, 29025006, -82065320),
                (200, 38984619, -94708190),
                (200, 39043838, -95074919),
                (201, 38850292, -77282719),
                (202, 30337249, -97761981),
                (203, 38254221, -85640839),
                (204, 26565005, -81831622),
                (206, 39179073, -84525453),
                (206, 39073909, -84037056),
                (206, 39417779, -84356947),
                (207, 41937888, -87721857),
                (207, 41796030, -87783137),
                (208, 26495084, -80127911),
                (208, 26124785, -80211868),
                (212, 33807013, -117915242),
                (212, 33648326, -117801481),
                (213, 45606226, -108904989),
                (213, 45856367, -108476528),
                (214, 42956963, -104379191),
                (215, 30089305, -94144666),
                (216, 32389427, -97343074),
                (217, 44854784, -91930383),
                (217, 44904390, -91363275),
                (217, 44538325, -91268033),
                (220, 44540569, -89925759),
                (220, 44913968, -89653311),
                (220, 44520060, -89495963)
        ) AS t(station_market_id, latitude_e6, longitude_e6)
);

INSERT INTO
    locations(latitude_e6, longitude_e6)
SELECT
    latitude_e6,
    longitude_e6
FROM
    market_locations ON CONFLICT DO NOTHING;

INSERT INTO
    service_region_canonical_locations(
        location_id,
        service_region_canonical_location_set_id
    )
SELECT
    locations.id,
    service_region_canonical_location_sets.id
FROM
    locations
    JOIN market_locations ON (
        locations.latitude_e6 = market_locations.latitude_e6
        AND locations.longitude_e6 = market_locations.longitude_e6
    )
    JOIN markets ON market_locations.station_market_id = markets.station_market_id
    JOIN service_region_canonical_location_sets ON service_region_canonical_location_sets.service_region_id = markets.service_region_id;

WITH market_durations AS (
    SELECT
        station_market_id,
        service_duration_sec
    FROM
        (
            VALUES
                (159, 1560),
                (160, 1998),
                (161, 1524),
                (162, 1548),
                (164, 1716),
                (165, 1554),
                (166, 2076),
                (168, 2436),
                (169, 1572),
                (170, 1824),
                (171, 1488),
                (172, 1812),
                (173, 1392),
                (174, 1974),
                (175, 1776),
                (176, 1602),
                (177, 1818),
                (178, 1590),
                (179, 1356),
                (181, 1476),
                (185, 1230),
                (186, 2196),
                (188, 1830),
                (189, 1056),
                (190, 1500),
                (191, 1470),
                (192, 1398),
                (193, 1380),
                (194, 1434),
                (195, 1584),
                (196, 1422),
                (197, 1554),
                (198, 1230),
                (199, 1380),
                (200, 2202),
                (201, 1524),
                (202, 1320),
                (203, 1608),
                (204, 1650),
                (206, 1326),
                (207, 1380),
                (208, 1428),
                (212, 1638),
                (213, 1482),
                (214, 1560),
                (215, 2436),
                (216, 1548),
                (217, 2112)
        ) AS t(station_market_id, service_duration_sec)
)
INSERT INTO
    service_region_minimal_visit_durations(service_region_id, service_duration_sec)
SELECT
    markets.service_region_id,
    market_durations.service_duration_sec
FROM
    markets
    JOIN market_durations ON market_durations.station_market_id = markets.station_market_id;

-- +goose StatementEnd
-- +goose Down
-- +goose StatementBegin
DELETE FROM
    service_region_canonical_locations;

DELETE FROM
    service_region_canonical_location_sets;

DELETE FROM
    service_region_minimal_visit_durations;

-- +goose StatementEnd
