# Patient Accounts Service

## Patient Accounts

Before their request is sent to the patient accounts service, a user will first authenticate with Auth0. The token generated by Auth0 will be attached to the `FindOrCreateAccountByToken` gRPC request, and the patient account will either be retrieved or created based on that information.

This token will only contain the `auth0_id` and `email`; the user's name and phone number will be collected after the account is created, and persisted with `UpdateAccount`

Patient Accounts have a one-to-many association with patients and unverified patients. A unique index ensures that only one account can be associated with each unverified patient.
Patient Accounts have a one-to-many association with care requests.

### AccountPatientLinks

A `Patient` or `UnverifiedPatient` will be associated with an account only when the `AddUnverifiedAccountPatientLink` endpoint is called.
The `PatientLink` also holds an `ACCESS_LEVEL`, which denotes the level of access that the account should have for the patient record.

### Addresses

Addresses will be required to go through validation before being added to the account. A call to `CreateAddress` or `UpdateAddress` will query the Google Maps Address Validation API.

If Google is able to geocode the given address to `PREMISE_PROXIMITY` or better, then the address will be considered valid.

If an address is valid, we will persist the Google-verified version of the address to the database. For example, if there is a typo and Google autocorrects it, we will persist the autocorrected version to our database. This validated address will be returned to the caller as part of the response, and displayed to the user so that there is no confusion to the user about what address was saved.

If the validated address is not what the user intended, they will have the opportunity to edit the address; the client will call `UpdateAddress` to attempt to persist this edited address.

For both the `CreateAddress` and `UpdateAddress` operations, we will not persist the address to the database if an address is invalid, and will instead return only a suggested address to the caller.

## Running Patient Accounts Service

It is recommended to run the service with `AUTHORIZATION_DISABLED=false` in [.env.development.local](../../../.env.development.local) to allow the service to interact with the OAuth token claims properly.

Run `scripts/run/patientaccounts_service.sh` to bring up all the necessary dependent services.

### Obtaining a User Access Token

Run the below command and follow the instructions:

```sh
./go/cmd/patientaccounts-service/get-access-token.sh <insert your email>
```

## Making a gRPC call

First, get a user access token from Auth0 by following the steps in the [obtaining a user access token section](#obtaining-a-user-access-token):

Then, use `grpcurl` and replace `exampletokenhere` with the user access token.

```
# Will return a suggested address, as validation will fail due to mispellings
bin/grpcurl -plaintext -H 'authorization: Bearer exampletokenhere' -d '{"account_id": 1, "address": {"address_line_one": "1600 Ampitheatre Pkwy", "city": "Montain View", "state": "CA", "zip_code": "94043-1351"}}' localhost:8477 patients.accounts.PatientAccountsService.CreateAddress

# Will create an address
bin/grpcurl -plaintext -H 'authorization: Bearer exampletokenhere' -d '{"account_id": 1, "address": {"address_line_one": "1600 Amphitheatre Pkwy", "city": "Mountain View", "state": "CA", "zip_code": "94043-1351"}}' localhost:8477 patients.accounts.PatientAccountsService.CreateAddress
```

## Obtaining a User Access Token

Run the below command and follow the instructions:

```sh
./go/cmd/patientaccounts-service/get-access-token.sh <insert your email>
```
